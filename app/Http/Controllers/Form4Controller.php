<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Carbon\Carbon;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Exception;
use Illuminate\Database\QueryException;
use App\Http\Traits\SessionHelper;

class Form4Controller extends Controller
{
    use SessionHelper;

    public function showForm()
    {
        // ‡πÉ‡∏ä‡πâ SessionHelper trait
        $this->initializeSession();

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö session ‡πÅ‡∏•‡∏∞ redirect ‡∏´‡∏≤‡∏Å‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        $sessionCheck = $this->validateSession();
        if ($sessionCheck) {
            return $sessionCheck;
        }

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• session ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        $sessionData = $this->getSessionData();

        // Debug session
        $this->debugSession('showForm');

        return view('form4', [
            'editMode' => false,
            'projectId' => $sessionData['project_id'],
            'system_detail' => '',
            'old_workflow' => '',
            'new_workflow' => '',
            'whouse_users' => [],
        ]);
    }

    public function store(Request $request)
    {
        // ‡πÉ‡∏ä‡πâ SessionHelper trait
        $this->initializeSession();

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö session ‡πÅ‡∏•‡∏∞ redirect ‡∏´‡∏≤‡∏Å‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        $sessionCheck = $this->validateSession();
        if ($sessionCheck) {
            return $sessionCheck;
        }

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• session ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        $sessionData = $this->getSessionData();
        $this->debugSession('store');

        $request->validate([
            'system_detail' => 'required|string|min:3',
            'old_workflow' => 'nullable|string',
            'new_workflow' => 'nullable|string',
            'whouse_users' => 'nullable|array',
        ], [
            'system_detail.required' => '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏∞‡∏ö‡∏ö',
            'system_detail.min' => '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£'
        ]);

        try {
            DB::beginTransaction();

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ô tplan
            if (!DB::table('tplan')->where('project_id', $sessionData['project_id'])->exists()) {
                throw new Exception("‚ùå project_id: {$sessionData['project_id']} ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á tplan");
            }

            Log::info('üß™ INSERT or UPDATE tworkflow', [
                'project_id' => $sessionData['project_id'],
                'workflow' => $request->input('system_detail'),
                'edit_id' => $sessionData['edit_id']
            ]);

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• workflow
            DB::table('tworkflow')->updateOrInsert(
                ['project_id' => $sessionData['project_id']],
                [
                    'workflow' => $request->input('system_detail'),
                    'old_workflow' => $request->input('old_workflow'),
                    'new_workflow' => $request->input('new_workflow'),
                    'rec_date' => Carbon::now(),
                    'edit_id' => $sessionData['edit_id'],
                ]
            );

            // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Ç‡∏≠‡∏á whouse ‡∏Å‡πà‡∏≠‡∏ô
            DB::table('twhouse')->where('project_id', $sessionData['project_id'])->delete();

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• whouse users ‡πÉ‡∏´‡∏°‡πà
            $whouseUsers = $request->input('whouse_users', []);
            foreach ($whouseUsers as $userLabel) {
                $whouseRecord = DB::table('tb_whouse')->where('name', $userLabel)->first();
                if ($whouseRecord) {
                    DB::table('twhouse')->insert([
                        'project_id' => $sessionData['project_id'],
                        'whouse_id' => $whouseRecord->id,
                        'rec_date' => Carbon::now(),
                        'edit_id' => $sessionData['edit_id'],
                    ]);
                }
            }

            DB::commit();

            Log::info('‚úÖ Form4 store success', [
                'project_id' => $sessionData['project_id'],
                'edit_id' => $sessionData['edit_id'],
                'whouse_users_count' => count($whouseUsers)
            ]);

            return redirect()->route('form5.show', ['id' => $sessionData['project_id']])
                ->with('success', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        } catch (QueryException $e) {
            DB::rollBack();
            Log::error('‚ùå Form4 SQL ERROR', [
                'sql_message' => $e->getMessage(),
                'bindings' => $e->getBindings(),
                'session_data' => $sessionData
            ]);
            return redirect()->back()->with('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î SQL ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö log')->withInput();
        } catch (Exception $e) {
            DB::rollBack();
            Log::error('‚ùå Form4 Store Exception', [
                'message' => $e->getMessage(),
                'line' => $e->getLine(),
                'session_data' => $sessionData
            ]);
            return redirect()->back()->with('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' . $e->getMessage())->withInput();
        }
    }

    public function edit($id)
    {
        // ‡πÉ‡∏ä‡πâ SessionHelper trait ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö edit mode
        $this->initializeSession($id);
        $sessionData = $this->getSessionData();
        $this->debugSession('edit');

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á tplan
        $plan = DB::table('tplan')->where('project_id', $id)->first();

        if (!$plan) {
            Log::error('‚ùå [edit] Project not found', ['project_id' => $id]);
            return redirect()->route('projects.index')->withErrors(['project' => '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£']);
        }

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏Å‡πÇ‡∏ü‡∏•‡∏ß‡πå
        $workflow = DB::table('tworkflow')->where('project_id', $id)->first();

        // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á)
        $whouseUsers = DB::table('twhouse')
            ->join('tb_whouse', 'twhouse.whouse_id', '=', 'tb_whouse.id')
            ->where('twhouse.project_id', $id)
            ->pluck('tb_whouse.name')
            ->toArray();

        return view('form4', [
            'plan' => $plan,
            'editMode' => true,
            'projectId' => $id,
            'system_detail' => $workflow?->workflow ?? '',
            'old_workflow' => $workflow?->old_workflow ?? '',
            'new_workflow' => $workflow?->new_workflow ?? '',
            'whouse_users' => $whouseUsers,
        ]);
    }

    public function update(Request $request, $id)
    {
        // ‡πÉ‡∏ä‡πâ SessionHelper trait ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö update
        $this->initializeSession($id);
        $sessionData = $this->getSessionData();
        $this->debugSession('update');

        $request->validate([
            'system_detail' => 'required|string|min:3',
            'old_workflow' => 'nullable|string',
            'new_workflow' => 'nullable|string',
            'whouse_users' => 'nullable|array',
        ], [
            'system_detail.required' => '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏∞‡∏ö‡∏ö',
            'system_detail.min' => '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£'
        ]);

        try {
            DB::beginTransaction();

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• workflow
            DB::table('tworkflow')->updateOrInsert(
                ['project_id' => $id],
                [
                    'workflow' => $request->input('system_detail'),
                    'old_workflow' => $request->input('old_workflow'),
                    'new_workflow' => $request->input('new_workflow'),
                    'rec_date' => Carbon::now(),
                    'edit_id' => $sessionData['edit_id'],
                ]
            );

            // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Ç‡∏≠‡∏á whouse
            DB::table('twhouse')->where('project_id', $id)->delete();

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• whouse users ‡πÉ‡∏´‡∏°‡πà
            foreach ($request->input('whouse_users', []) as $userLabel) {
                $whouseRecord = DB::table('tb_whouse')->where('name', $userLabel)->first();
                if ($whouseRecord) {
                    DB::table('twhouse')->insert([
                        'project_id' => $id,
                        'whouse_id' => $whouseRecord->id,
                        'rec_date' => Carbon::now(),
                        'edit_id' => $sessionData['edit_id'],
                    ]);
                }
            }

            DB::commit();

            Log::info('‚úÖ Form4 update success', [
                'project_id' => $id,
                'edit_id' => $sessionData['edit_id'],
                'whouse_users_count' => count($request->input('whouse_users', []))
            ]);

            return redirect()->route('form4.edit', ['id' => $id])
                ->with('success', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        } catch (Exception $e) {
            DB::rollBack();
            Log::error('‚ùå Form4 Update Error', [
                'message' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
                'project_id' => $id,
                'session_data' => $sessionData
            ]);
            return back()->withErrors(['db' => '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ' . $e->getMessage()])->withInput();
        }
    }
}

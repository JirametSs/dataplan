<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Carbon\Carbon;
use Exception;
use App\Http\Traits\SessionHelper;

class Form5Controller extends Controller
{
    use SessionHelper;

    public function showForm()
    {
        // ‡πÉ‡∏ä‡πâ SessionHelper trait
        $this->initializeSession();

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö session ‡πÅ‡∏•‡∏∞ redirect ‡∏´‡∏≤‡∏Å‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        $sessionCheck = $this->validateSession();
        if ($sessionCheck) {
            return $sessionCheck;
        }

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• session ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        $sessionData = $this->getSessionData();

        // Debug session
        $this->debugSession('showForm');

        return view('form5', [
            'projectId' => $sessionData['project_id'],
            'goals' => [], // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö showForm
            'editMode' => false
        ]);
    }

    public function store(Request $request)
    {
        // ‡πÉ‡∏ä‡πâ SessionHelper trait
        $this->initializeSession();

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö session ‡πÅ‡∏•‡∏∞ redirect ‡∏´‡∏≤‡∏Å‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        $sessionCheck = $this->validateSession();
        if ($sessionCheck) {
            return $sessionCheck;
        }

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• session ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        $sessionData = $this->getSessionData();
        $this->debugSession('store');

        Log::info('[FORM5] üîÑ Raw goals input (store)', [
            'raw_input' => $request->input('goals'),
            'all_inputs' => $request->all(),
            'project_id' => $sessionData['project_id'],
            'edit_id' => $sessionData['edit_id']
        ]);

        $request->validate([
            'goals' => 'nullable|json'
        ], [
            'goals.json' => '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'
        ]);

        $goals = json_decode($request->input('goals') ?? '[]', true);

        if (!is_array($goals)) {
            return back()->withErrors(['goals' => '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'])->withInput();
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        $validGoals = collect($goals)->filter(function ($goal) {
            return !empty(trim($goal['detail'] ?? ''));
        })->values()->toArray();

        if (empty($validGoals)) {
            return back()->withErrors(['goals' => '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'])->withInput();
        }

        Log::info('üì• Form5 store - ‡πÄ‡∏£‡∏¥‡πà‡∏° insert ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ttarget', [
            'project_id' => $sessionData['project_id'],
            'edit_id' => $sessionData['edit_id'],
            'goals_count' => count($validGoals)
        ]);

        try {
            DB::beginTransaction();

            // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
            DB::table('ttarget')->where('project_id', $sessionData['project_id'])->delete();

            $inserted = 0;
            foreach ($validGoals as $goal) {
                $detail = trim($goal['detail'] ?? '');
                if (!empty($detail)) {
                    DB::table('ttarget')->insert([
                        'project_id' => $sessionData['project_id'],
                        'detail' => $detail,
                        'rec_date' => Carbon::now(),
                        'edit_id' => $sessionData['edit_id'],
                    ]);
                    $inserted++;
                }
            }

            DB::commit();

            Log::info("‚úÖ Form5 store success - ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", [
                'project_id' => $sessionData['project_id'],
                'edit_id' => $sessionData['edit_id'],
                'inserted_rows' => $inserted
            ]);

            return redirect()->route('form6.show', ['id' => $sessionData['project_id']])
                ->with('success', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        } catch (Exception $e) {
            DB::rollBack();
            Log::error('‚ùå Form5 Store Error', [
                'message' => $e->getMessage(),
                'line' => $e->getLine(),
                'trace' => $e->getTraceAsString(),
                'session_data' => $sessionData
            ]);
            return back()->with('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' . $e->getMessage())->withInput();
        }
    }

    public function edit($id)
    {
        // ‡πÉ‡∏ä‡πâ SessionHelper trait ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö edit mode
        $this->initializeSession($id);
        $sessionData = $this->getSessionData();
        $this->debugSession('edit');

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å tplan
        $plan = DB::table('tplan')->where('project_id', $id)->first();

        if (!$plan) {
            Log::error('‚ùå [edit] Project not found', ['project_id' => $id]);
            return redirect()->route('projects.index')->withErrors(['project' => '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£']);
        }

        // ‡∏î‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏≤‡∏Å ttarget
        $goals = DB::table('ttarget')
            ->where('project_id', $id)
            ->select('detail')
            ->get()
            ->map(fn($row) => ['detail' => $row->detail])
            ->toArray();

        return view('form5', [
            'plan' => $plan,
            'editMode' => true,
            'projectId' => $id,
            'goals' => $goals,
        ]);
    }

    public function update(Request $request, $id)
    {
        // ‡πÉ‡∏ä‡πâ SessionHelper trait ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö update
        $this->initializeSession($id);
        $sessionData = $this->getSessionData();
        $this->debugSession('update');

        Log::info('[FORM5] üîÑ Raw goals input (update)', [
            'raw_input' => $request->input('goals'),
            'all_inputs' => $request->all(),
            'project_id' => $id,
            'edit_id' => $sessionData['edit_id']
        ]);

        $request->validate([
            'goals' => 'nullable|json'
        ], [
            'goals.json' => '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'
        ]);

        $goals = json_decode($request->input('goals') ?? '[]', true);

        if (!is_array($goals)) {
            return back()->withErrors(['goals' => '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'])->withInput();
        }

        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        $validGoals = collect($goals)->filter(function ($goal) {
            return !empty(trim($goal['detail'] ?? ''));
        })->values()->toArray();

        Log::info('üì• Form5 update - ‡πÄ‡∏£‡∏¥‡πà‡∏° update ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ttarget', [
            'project_id' => $id,
            'edit_id' => $sessionData['edit_id'],
            'goals_count' => count($validGoals)
        ]);

        try {
            DB::beginTransaction();

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
            $existingGoals = DB::table('ttarget')
                ->where('project_id', $id)
                ->pluck('detail')
                ->toArray();

            $newInserted = 0;
            $duplicates = 0;

            foreach ($validGoals as $goal) {
                $detail = trim($goal['detail'] ?? '');
                if (!empty($detail)) {
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                    if (!in_array($detail, $existingGoals)) {
                        // ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
                        DB::table('ttarget')->insert([
                            'project_id' => $id,
                            'detail' => $detail,
                            'rec_date' => Carbon::now(),
                            'edit_id' => $sessionData['edit_id'],
                        ]);
                        $newInserted++;

                        Log::info('[FORM5] ‚ûï Added new goal', [
                            'project_id' => $id,
                            'detail' => $detail
                        ]);
                    } else {
                        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥ - ‡∏Ç‡πâ‡∏≤‡∏°
                        $duplicates++;

                        Log::info('[FORM5] ‚ö†Ô∏è Duplicate goal skipped', [
                            'project_id' => $id,
                            'detail' => $detail
                        ]);
                    }
                }
            }

            DB::commit();

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            $message = '';
            if ($newInserted > 0 && $duplicates > 0) {
                $message = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà {$newInserted} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏Ç‡πâ‡∏≤‡∏° {$duplicates} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥)";
            } elseif ($newInserted > 0) {
                $message = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà {$newInserted} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß";
            } elseif ($duplicates > 0) {
                $message = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (‡∏Ç‡πâ‡∏≤‡∏° {$duplicates} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥)";
            } else {
                $message = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°";
            }

            Log::info("‚úÖ Form5 update success - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", [
                'project_id' => $id,
                'edit_id' => $sessionData['edit_id'],
                'new_inserted' => $newInserted,
                'duplicates' => $duplicates
            ]);

            return redirect()->route('form5.edit', ['id' => $id])
                ->with('success', $message);
        } catch (Exception $e) {
            DB::rollBack();
            Log::error('‚ùå Form5 Update Error', [
                'message' => $e->getMessage(),
                'line' => $e->getLine(),
                'trace' => $e->getTraceAsString(),
                'project_id' => $id,
                'session_data' => $sessionData
            ]);
            return back()->with('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ' . $e->getMessage())->withInput();
        }
    }

    /**
     * ‡∏•‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
     */
    public function deleteGoal(Request $request, $id)
    {
        $this->initializeSession($id);
        $sessionData = $this->getSessionData();

        $request->validate([
            'detail' => 'required|string'
        ]);

        try {
            $deleted = DB::table('ttarget')
                ->where('project_id', $id)
                ->where('detail', $request->input('detail'))
                ->delete();

            if ($deleted > 0) {
                Log::info('[FORM5] üóëÔ∏è Goal deleted', [
                    'project_id' => $id,
                    'detail' => $request->input('detail')
                ]);

                return response()->json([
                    'success' => true,
                    'message' => '‡∏•‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
                ]);
            } else {
                return response()->json([
                    'success' => false,
                    'message' => '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö'
                ], 404);
            }
        } catch (Exception $e) {
            Log::error('‚ùå Form5 Delete Goal Exception', [
                'message' => $e->getMessage(),
                'project_id' => $id,
                'detail' => $request->input('detail')
            ]);

            return response()->json([
                'success' => false,
                'message' => '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Route ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debug (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô web.php ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
     */
    public function debug(Request $request, $id)
    {
        return response()->json([
            'request_all' => $request->all(),
            'request_method' => $request->method(),
            'content_type' => $request->header('Content-Type'),
            'raw_content' => $request->getContent(),
            'project_id' => $id
        ]);
    }
}
